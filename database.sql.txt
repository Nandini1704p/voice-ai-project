-- 1. EXTENSIONS (UUID sathi)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. ORGANIZATIONS
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    custom_id VARCHAR(50) UNIQUE,  -- Tumchā 'org-1' ithe yeīl
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    industry VARCHAR(100) NOT NULL,
    website VARCHAR(255),
    address TEXT,
    credit_balance DECIMAL(12,2) DEFAULT 0,
    low_balance_threshold DECIMAL(10,2) DEFAULT 1000,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
    last_active_at TIMESTAMP WITH TIME ZONE,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 3. USERS
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    custom_user_id VARCHAR(50) UNIQUE, -- Tumchā 'user-admin' ithe yeīl
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    display_name VARCHAR(200),
    role VARCHAR(30) NOT NULL CHECK (role IN ('admin', 'customer_admin')),
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP WITH TIME ZONE,
    notification_settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 4. user_sessions
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(500) NOT NULL,
    ip_address VARCHAR(50),
    user_agent TEXT,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 5. PROGRAMS
CREATE TABLE programs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    program_type VARCHAR(100),
    duration VARCHAR(100),
    intake_period VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 6. knowledge_base_documents
CREATE TABLE knowledge_base_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    file_name VARCHAR(255),
    file_url TEXT,
    file_size_bytes BIGINT,
    mime_type VARCHAR(100),
    
    -- Processed content for AI
    extracted_text TEXT,
    embedding_status VARCHAR(30) DEFAULT 'pending' CHECK (embedding_status IN ('pending', 'processing', 'completed', 'failed')),
    uploaded_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 5. CAMPAIGNS
CREATE TABLE campaigns (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    custom_campaign_id VARCHAR(50) UNIQUE, -- Tumchā 'camp-1' sathi
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    program_id UUID REFERENCES programs(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(30) DEFAULT 'draft' CHECK (status IN ('draft', 'scheduled', 'running', 'paused', 'completed')),
    total_contacts INTEGER DEFAULT 0,
    calls_made INTEGER DEFAULT 0,
    calls_connected INTEGER DEFAULT 0,
    conversions INTEGER DEFAULT 0,
    total_cost DECIMAL(12,2) DEFAULT 0,
    scheduled_start_at TIMESTAMP WITH TIME ZONE,
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 6. contacts
CREATE TABLE contacts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    phone VARCHAR(20) NOT NULL,                    -- "+91 98765 43210"
    phone_normalized VARCHAR(20),                  -- "+919876543210" (E.164)
    name VARCHAR(200),                             -- "Rajesh Patel"
    email VARCHAR(255),                            -- "rajesh@email.com"
    custom_data JSONB DEFAULT '{}',
    is_dnc BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, phone_normalized)
);

-- 7. Campaign-Contact relationship (many-to-many with campaign-specific data)
CREATE TABLE campaign_contacts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
    contact_id UUID NOT NULL REFERENCES contacts(id) ON DELETE CASCADE,
    status VARCHAR(30) DEFAULT 'pending' CHECK (status IN ('pending', 'calling', 'completed', 'failed', 'skipped')),
    -- Attempt tracking
    attempts INTEGER DEFAULT 0,
    last_attempt_at TIMESTAMP WITH TIME ZONE,
    -- Outcome for this campaign
    outcome VARCHAR(50),                           -- "Converted - Interested", "Not Interested", etc.
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(campaign_id, contact_id)
);

-- 8. calls
CREATE TABLE calls (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    campaign_id UUID REFERENCES campaigns(id) ON DELETE SET NULL,
    contact_id UUID REFERENCES contacts(id) ON DELETE SET NULL,
    -- External provider reference
    external_call_id VARCHAR(100),                 -- Bolna/Exotel call ID
    -- Contact info (denormalized for display)
    contact_name VARCHAR(200),                     -- "Rajesh Patel"
    contact_phone VARCHAR(20),                     -- "+91 98765 43210"
    -- Timing
    started_at TIMESTAMP WITH TIME ZONE NOT NULL,  -- "Jan 07, 2025 14:30"
    answered_at TIMESTAMP WITH TIME ZONE,
    ended_at TIMESTAMP WITH TIME ZONE,
    duration_seconds INTEGER DEFAULT 0,            -- 312 (5.2 min)
    -- Status
    status VARCHAR(30) DEFAULT 'initiated' CHECK (status IN (
        'initiated', 'ringing', 'in_progress', 'completed', 
        'no_answer', 'busy', 'failed'
    )),
    -- Outcome (from AI or manual)
    outcome VARCHAR(100),                          -- "Converted - Interested", "Callback Requested", "Not Interested"
    -- Recording
    recording_url TEXT,
    recording_duration_seconds INTEGER,            -- 238 (3:58)
   	-- Cost
    cost_amount DECIMAL(10,4) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 8. call_transcripts
CREATE TABLE call_transcripts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    call_id UUID NOT NULL REFERENCES calls(id) ON DELETE CASCADE,
    -- Full transcript text (searchable)
    full_text TEXT,
    -- Structured messages: [{role: "agent"|"contact", content: "...", timestamp: "..."}]
    messages JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 9. call_captured_data
CREATE TABLE call_captured_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    call_id UUID NOT NULL REFERENCES calls(id) ON DELETE CASCADE,
    contact_id UUID REFERENCES contacts(id) ON DELETE SET NULL,
    -- Structured captured fields
    -- Example: interested: Yes, eligible: Yes, preferred_intake: Fall 2025, email: rajesh@email.com
    field_name VARCHAR(100) NOT NULL,              -- "Interested", "Eligible", "Preferred Intake", "Email"
    field_value TEXT,                              -- "Yes", "Fall 2025", "rajesh@email.com"
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);


-- Alternative: Store all captured data as JSON on the call
-- ALTER TABLE calls ADD COLUMN captured_data JSONB DEFAULT '{}';

-- =====================================================

-- 10. FOLLOW-UPS (Escalations & Callbacks)
CREATE TABLE follow_ups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    campaign_id UUID REFERENCES campaigns(id) ON DELETE SET NULL,
    call_id UUID REFERENCES calls(id) ON DELETE SET NULL,
    contact_id UUID REFERENCES contacts(id) ON DELETE SET NULL,
    -- Contact info (denormalized)
    contact_phone VARCHAR(20),                     -- "+91 87654 32109"
    -- Type: callback, escalation, other
    type VARCHAR(30) NOT NULL CHECK (type IN ('callback', 'escalation', 'other')),
    -- Reason/Notes
    reason TEXT,                                   -- "Contact requested callback at 6 PM"
    -- Status
    status VARCHAR(30) DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled')),
    -- Scheduling
    scheduled_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    completed_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 11. credit_transactions
CREATE TABLE credit_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Transaction type
    type VARCHAR(30) NOT NULL CHECK (type IN ('credit_add', 'campaign_usage', 'refund', 'adjustment')),
    
    -- Amount (positive for credits added, negative for usage)
    amount DECIMAL(12,2) NOT NULL,                 -- -₹1,872 or +₹10,000
    
    -- Balance after transaction
    balance_after DECIMAL(12,2) NOT NULL,
    
    -- Reference
    reference_type VARCHAR(50),                    -- "campaign", "manual", "payment"
    reference_id UUID,                             -- campaign_id if campaign usage
    description TEXT,                              -- "Campaign Usage" or "Credits Added via Razorpay"
    
    -- Payment details (for credit additions)
    payment_method VARCHAR(50),
    payment_reference VARCHAR(100),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 12. daily_usage 
CREATE TABLE daily_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    
    -- Call metrics
    total_calls INTEGER DEFAULT 0,
    total_minutes DECIMAL(10,2) DEFAULT 0,
    
    -- Cost
    total_cost DECIMAL(12,2) DEFAULT 0,
    
    -- Conversion metrics
    conversions INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, date)
);

-- 13. ACTIVITY LOG (Recent Activity Feed)
CREATE TABLE activity_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,  -- NULL for platform-wide
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    -- Activity type
    activity_type VARCHAR(100) NOT NULL,           -- "campaign_started", "customer_onboarded", "escalation_reported", "campaign_completed"
    
    -- Title & description for display
    title VARCHAR(255) NOT NULL,                   -- "New Campaign Started"
    description TEXT,                              -- "Global Institute - MBA Fall 2025"
    
    -- Reference to related entity
    entity_type VARCHAR(50),                       -- "campaign", "organization", "follow_up"
    entity_id UUID,
    
    -- Icon type for UI
    icon_type VARCHAR(30),                         -- "campaign", "customer", "escalation"
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 14. SYSTEM SETTINGS (Platform-wide)
CREATE TABLE system_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT,
    value_type VARCHAR(20) DEFAULT 'string',       -- string, number, boolean, json
    description TEXT,
    updated_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 15. API KEYS (for API Access settings tab)
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    key_hash VARCHAR(255) NOT NULL,                -- Hashed API key
    key_prefix VARCHAR(10) NOT NULL,               -- First 8 chars for identification
    
    -- Permissions
    permissions JSONB DEFAULT '[]',
    
    -- Usage tracking
    last_used_at TIMESTAMP WITH TIME ZONE,
    request_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    expires_at TIMESTAMP WITH TIME ZONE,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 16. INDEXES
-- =====================================================

-- Organizations
CREATE INDEX idx_organizations_status ON organizations(status);
CREATE INDEX idx_organizations_industry ON organizations(industry);

-- Users
CREATE INDEX idx_users_organization ON users(organization_id);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);

-- Programs
CREATE INDEX idx_programs_organization ON programs(organization_id);

-- Knowledge Base
CREATE INDEX idx_kb_documents_organization ON knowledge_base_documents(organization_id);

-- Campaigns
CREATE INDEX idx_campaigns_organization ON campaigns(organization_id);
CREATE INDEX idx_campaigns_status ON campaigns(status);
CREATE INDEX idx_campaigns_program ON campaigns(program_id);

-- Contacts
CREATE INDEX idx_contacts_organization ON contacts(organization_id);
CREATE INDEX idx_contacts_phone ON contacts(phone_normalized);

-- Campaign Contacts
CREATE INDEX idx_campaign_contacts_campaign ON campaign_contacts(campaign_id);
CREATE INDEX idx_campaign_contacts_contact ON campaign_contacts(contact_id);
CREATE INDEX idx_campaign_contacts_status ON campaign_contacts(status);

-- Calls
CREATE INDEX idx_calls_organization ON calls(organization_id);
CREATE INDEX idx_calls_campaign ON calls(campaign_id);
CREATE INDEX idx_calls_contact ON calls(contact_id);
CREATE INDEX idx_calls_started_at ON calls(started_at);
CREATE INDEX idx_calls_outcome ON calls(outcome);

-- Follow-ups
CREATE INDEX idx_follow_ups_organization ON follow_ups(organization_id);
CREATE INDEX idx_follow_ups_status ON follow_ups(status);
CREATE INDEX idx_follow_ups_type ON follow_ups(type);

-- Credit Transactions
CREATE INDEX idx_credit_transactions_organization ON credit_transactions(organization_id);
CREATE INDEX idx_credit_transactions_created_at ON credit_transactions(created_at);

-- Daily Usage
CREATE INDEX idx_daily_usage_organization_date ON daily_usage(organization_id, date);

-- Activity Log
CREATE INDEX idx_activity_log_organization ON activity_log(organization_id);
CREATE INDEX idx_activity_log_created_at ON activity_log(created_at);

-- =====================================================
-- TRIGGERS FOR UPDATED_AT
-- =====================================================

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_organizations_updated_at BEFORE UPDATE ON organizations FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_programs_updated_at BEFORE UPDATE ON programs FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_kb_documents_updated_at BEFORE UPDATE ON knowledge_base_documents FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_campaigns_updated_at BEFORE UPDATE ON campaigns FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_contacts_updated_at BEFORE UPDATE ON contacts FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_campaign_contacts_updated_at BEFORE UPDATE ON campaign_contacts FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_calls_updated_at BEFORE UPDATE ON calls FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_call_transcripts_updated_at BEFORE UPDATE ON call_transcripts FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_follow_ups_updated_at BEFORE UPDATE ON follow_ups FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_system_settings_updated_at BEFORE UPDATE ON system_settings FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_api_keys_updated_at BEFORE UPDATE ON api_keys FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Insert sample organizations
INSERT INTO organizations (custom_id, name, slug, industry, credit_balance, status, last_active_at) VALUES
('org-1', 'Global Institute of Management', 'global-institute-of-management', 'Education', 15000.00, 'active', '2025-01-07'),
('org-2', 'Delhi Business University', 'delhi-business-university', 'Education', 8500.00, 'active', '2025-01-06'),
('org-3', 'Tech Startup Accelerator', 'tech-startup-accelerator', 'Education', 2300.00, 'active', '2025-01-05');

-- Insert sample users
INSERT INTO users (custom_user_id, organization_id, email, password_hash, display_name, role) VALUES
('user-admin', NULL, 'admin@voiceai.com', '$2b$10$xyz...', 'Admin User', 'admin'),
('user-sarah', (SELECT id FROM organizations WHERE custom_id = 'org-1'), 'contact@oim.edu', '$2b$10$abc...', 'Dr. Sarah Kumar', 'customer_admin');

-- Insert sample campaigns (Linking with org-1's UUID)
INSERT INTO campaigns (custom_campaign_id, organization_id, name, status, total_contacts, calls_made, conversions, total_cost) VALUES
('camp-1', (SELECT id FROM organizations WHERE custom_id = 'org-1'), 'MBA Fall 2025 Intake', 'running', 500, 234, 45, 1872.00),
('camp-2', (SELECT id FROM organizations WHERE custom_id = 'org-1'), 'Executive Education Webinar', 'scheduled', 300, 0, 0, 0.00),
('camp-3', (SELECT id FROM organizations WHERE custom_id = 'org-1'), 'Alumni Engagement Drive', 'completed', 250, 250, 67, 1500.00);

-- Insert sample contacts (Linking with org-1)
INSERT INTO contacts (organization_id, phone, phone_normalized, name, email) VALUES
((SELECT id FROM organizations WHERE custom_id = 'org-1'), '+919876543210', '919876543210', 'Rahul Sharma', 'rahul@example.com'),
((SELECT id FROM organizations WHERE custom_id = 'org-1'), '+918765432109', '918765432109', 'Priya Patel', 'priya@example.com');
